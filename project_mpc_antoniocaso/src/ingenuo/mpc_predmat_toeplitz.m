%%%%  Generate prediction equations (using toeplitz/hankel matrices) from %%%%  MFD model   A y(k+1) = B u(k)%%%%%%%%  yfut = H *Dufut + P*Dupast + Q*ypast%%%%%%%%  [H,P,Q] = mpc_predmat_toeplitz(A,B,ny)%%%%%%%%  ny is the output horizon%%  %% Author: J.A. Rossiter  (email: J.A.Rossiter@shef.ac.uk)function [H,P,Q] = mpc_predmat_toeplitz(A,B,ny);%%%%% Add integral to modelsizey = size(A,1);D = [eye(sizey),-eye(sizey)];AD = convmat(A,D);nA = size(AD,2);nB = size(B,2);%%%% Find toeplitz and hankel matrices and hence predictions[Ca,Ha]=caha(AD,sizey,ny);[Cb,Hb]=caha(B,sizey,ny);Cai=inv(Ca);H=Cai*Cb; P=Cai*Hb; Q=-Cai*Ha;%    function [C]=convmat(A,B)%    to convolve two matrix polynomials stored as [a(0),a(1),a(2)...]%   routine works by forming a convolution matrix [a(0),0   ,0   ,...%                                                a(1),a(0),0   ,...%                                                a(2),a(1),a(0),...]function [C]=convmat(A,B)[na,ma]=size(A);[nb,mb]=size(B);orda=ma/nb;ordb=mb/na;mat = [];for i=1:orda;    s = zeros(nb,((orda-1)*na+mb));    s(:,(i-1)*na+1:(i-1)*na+mb) = B;    mat = [mat;s];end;C=A*mat;